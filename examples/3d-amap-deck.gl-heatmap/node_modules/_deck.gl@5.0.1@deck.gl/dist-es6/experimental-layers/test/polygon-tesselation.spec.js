// Copyright (c) 2015 - 2017 Uber Technologies, Inc.
//
// Permission is hereby granted, free of charge, to any person obtaining a copy
// of this software and associated documentation files (the "Software"), to deal
// in the Software without restriction, including without limitation the rights
// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
// copies of the Software, and to permit persons to whom the Software is
// furnished to do so, subject to the following conditions:
//
// The above copyright notice and this permission notice shall be included in
// all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
// THE SOFTWARE.

import test from 'tape-catch';

import * as Polygon from 'deck.gl-layers/solid-polygon-layer/polygon';
import { PolygonTesselator } from 'deck.gl-layers/solid-polygon-layer/polygon-tesselator';

var POLYGONS = [[], [[1, 1]], [[1, 1], [1, 1], [1, 1]], [[[1, 1]]], [[[1, 1], [1, 1], [1, 1]]]];

var TEST_DATA = [{
  title: 'Plain array',
  polygons: POLYGONS
}];

var TEST_CASES = [{
  title: 'Tesselation(flat)',
  params: {}
}, {
  title: 'Tesselation(extruded)',
  params: { extruded: true }
}, {
  title: 'Tesselation(flat,fp64)',
  params: { fp64: true }
}, {
  title: 'Tesselation(extruded,fp64)',
  params: { extruded: true, fp64: true }
}];

test('polygon#imports', function (t) {
  t.ok(typeof Polygon.normalize === 'function', 'Polygon.normalize imported');
  t.ok(typeof Polygon.getVertexCount === 'function', 'Polygon.getVertexCount imported');
  t.ok(typeof Polygon.getTriangleCount === 'function', 'Polygon.getTriangleCount imported');
  t.ok(typeof Polygon.forEachVertex === 'function', 'Polygon.forEachVertex imported');
  t.end();
});

test('polygon#functions', function (t) {
  var _iteratorNormalCompletion = true;
  var _didIteratorError = false;
  var _iteratorError = undefined;

  try {
    for (var _iterator = POLYGONS[Symbol.iterator](), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
      var polygon = _step.value;

      t.ok(Array.isArray(Polygon.normalize(polygon)), 'Polygon.normalize');
      t.ok(Number.isFinite(Polygon.getTriangleCount(polygon)), 'Polygon.getTriangleCount');
      t.ok(Number.isFinite(Polygon.getVertexCount(polygon)), 'Polygon.getVertexCount');
    }
  } catch (err) {
    _didIteratorError = true;
    _iteratorError = err;
  } finally {
    try {
      if (!_iteratorNormalCompletion && _iterator.return) {
        _iterator.return();
      }
    } finally {
      if (_didIteratorError) {
        throw _iteratorError;
      }
    }
  }

  t.end();
});

test('polygonTesselator#imports', function (t) {
  t.ok(typeof PolygonTesselator === 'function', 'PolygonTesselator imported');
  t.end();
});

test('PolygonTesselator#constructor', function (t) {
  TEST_DATA.forEach(function (testData) {
    t.comment('Polygon data: ' + testData.title);
    var tesselator = new PolygonTesselator({ polygons: testData.polygons });
    t.ok(tesselator instanceof PolygonTesselator, 'PolygonTesselator created');

    TEST_CASES.forEach(function (testCase) {
      t.comment('  ' + testCase.title);
      tesselator.updatePositions(testCase.params);

      t.ok(ArrayBuffer.isView(tesselator.positions()), 'PolygonTesselator.positions');
      t.ok(ArrayBuffer.isView(tesselator.nextPositions()), 'PolygonTesselator.nextPositions');

      if (testCase.params.fp64) {
        t.ok(ArrayBuffer.isView(tesselator.positions64xyLow()), 'PolygonTesselator.positions64xyLow');
        t.ok(ArrayBuffer.isView(tesselator.nextPositions64xyLow()), 'PolygonTesselator.nextPositions64xyLow');
      }
    });
  });

  t.end();
});

test('PolygonTesselator#methods', function (t) {
  TEST_DATA.forEach(function (testData) {
    t.comment('Polygon data: ' + testData.title);
    var tesselator = new PolygonTesselator({ polygons: testData.polygons });

    t.ok(ArrayBuffer.isView(tesselator.indices()), 'PolygonTesselator.indices');
    t.ok(ArrayBuffer.isView(tesselator.colors()), 'PolygonTesselator.colors');
    t.ok(ArrayBuffer.isView(tesselator.pickingColors()), 'PolygonTesselator.pickingColors');
  });

  t.end();
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9leHBlcmltZW50YWwtbGF5ZXJzL3Rlc3QvcG9seWdvbi10ZXNzZWxhdGlvbi5zcGVjLmpzIl0sIm5hbWVzIjpbInRlc3QiLCJQb2x5Z29uIiwiUG9seWdvblRlc3NlbGF0b3IiLCJQT0xZR09OUyIsIlRFU1RfREFUQSIsInRpdGxlIiwicG9seWdvbnMiLCJURVNUX0NBU0VTIiwicGFyYW1zIiwiZXh0cnVkZWQiLCJmcDY0IiwidCIsIm9rIiwibm9ybWFsaXplIiwiZ2V0VmVydGV4Q291bnQiLCJnZXRUcmlhbmdsZUNvdW50IiwiZm9yRWFjaFZlcnRleCIsImVuZCIsInBvbHlnb24iLCJBcnJheSIsImlzQXJyYXkiLCJOdW1iZXIiLCJpc0Zpbml0ZSIsImZvckVhY2giLCJjb21tZW50IiwidGVzdERhdGEiLCJ0ZXNzZWxhdG9yIiwidGVzdENhc2UiLCJ1cGRhdGVQb3NpdGlvbnMiLCJBcnJheUJ1ZmZlciIsImlzVmlldyIsInBvc2l0aW9ucyIsIm5leHRQb3NpdGlvbnMiLCJwb3NpdGlvbnM2NHh5TG93IiwibmV4dFBvc2l0aW9uczY0eHlMb3ciLCJpbmRpY2VzIiwiY29sb3JzIiwicGlja2luZ0NvbG9ycyJdLCJtYXBwaW5ncyI6IkFBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUEsT0FBT0EsSUFBUCxNQUFpQixZQUFqQjs7QUFFQSxPQUFPLEtBQUtDLE9BQVosTUFBeUIsNENBQXpCO0FBQ0EsU0FBUUMsaUJBQVIsUUFBZ0MsdURBQWhDOztBQUVBLElBQU1DLFdBQVcsQ0FBQyxFQUFELEVBQUssQ0FBQyxDQUFDLENBQUQsRUFBSSxDQUFKLENBQUQsQ0FBTCxFQUFlLENBQUMsQ0FBQyxDQUFELEVBQUksQ0FBSixDQUFELEVBQVMsQ0FBQyxDQUFELEVBQUksQ0FBSixDQUFULEVBQWlCLENBQUMsQ0FBRCxF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WixDQUFtQkosV0FBV0ssU0FBWCxFQUFuQixDQUFMLEVBQWlELDZCQUFqRDtBQUNBcEIsUUFBRUMsRUFBRixDQUFLaUIsWUFBWUMsTUFBWixDQUFtQkosV0FBV00sYUFBWCxFQUFuQixDQUFMLEVBQXFELGlDQUFyRDs7QUFFQSxVQUFJTCxTQUFTbkIsTUFBVCxDQUFnQkUsSUFBcEIsRUFBMEI7QUFDeEJDLFVBQUVDLEVBQUYsQ0FDRWlCLFlBQVlDLE1BQVosQ0FBbUJKLFdBQVdPLGdCQUFYLEVBQW5CLENBREYsRUFFRSxvQ0FGRjtBQUlBdEIsVUFBRUMsRUFBRixDQUNFaUIsWUFBWUMsTUFBWixDQUFtQkosV0FBV1Esb0JBQVgsRUFBbkIsQ0FERixFQUVFLHdDQUZGO0FBSUQ7QUFDRixLQWpCRDtBQWtCRCxHQXZCRDs7QUF5QkF2QixJQUFFTSxHQUFGO0FBQ0QsQ0EzQkQ7O0FBNkJBakIsS0FBSywyQkFBTCxFQUFrQyxhQUFLO0FBQ3JDSSxZQUFVbUIsT0FBVixDQUFrQixvQkFBWTtBQUM1QlosTUFBRWEsT0FBRixvQkFBMkJDLFNBQVNwQixLQUFwQztBQUNBLFFBQU1xQixhQUFhLElBQUl4QixpQkFBSixDQUFzQixFQUFDSSxVQUFVbUIsU0FBU25CLFFBQXBCLEVBQXRCLENBQW5COztBQUVBSyxNQUFFQyxFQUFGLENBQUtpQixZQUFZQyxNQUFaLENBQW1CSixXQUFXUyxPQUFYLEVBQW5CLENBQUwsRUFBK0MsMkJBQS9DO0FBQ0F4QixNQUFFQyxFQUFGLENBQUtpQixZQUFZQyxNQUFaLENBQW1CSixXQUFXVSxNQUFYLEVBQW5CLENBQUwsRUFBOEMsMEJBQTlDO0FBQ0F6QixNQUFFQyxFQUFGLENBQUtpQixZQUFZQyxNQUFaLENBQW1CSixXQUFXVyxhQUFYLEVBQW5CLENBQUwsRUFBcUQsaUNBQXJEO0FBQ0QsR0FQRDs7QUFTQTFCLElBQUVNLEdBQUY7QUFDRCxDQVhEIiwiZmlsZSI6InBvbHlnb24tdGVzc2VsYXRpb24uc3BlYy5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAoYykgMjAxNSAtIDIwMTcgVWJlciBUZWNobm9sb2dpZXMsIEluYy5cbi8vXG4vLyBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5XG4vLyBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZSBcIlNvZnR3YXJlXCIpLCB0byBkZWFsXG4vLyBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzXG4vLyB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsXG4vLyBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXNcbi8vIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6XG4vL1xuLy8gVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQgaW5cbi8vIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLlxuLy9cbi8vIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCBcIkFTIElTXCIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1Jcbi8vIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLFxuLy8gRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFXG4vLyBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSXG4vLyBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLFxuLy8gT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTlxuLy8gVEhFIFNPRlRXQVJFLlxuXG5pbXBvcnQgdGVzdCBmcm9tICd0YXBlLWNhdGNoJztcblxuaW1wb3J0ICogYXMgUG9seWdvbiBmcm9tICdkZWNrLmdsLWxheWVycy9zb2xpZC1wb2x5Z29uLWxheWVyL3BvbHlnb24nO1xuaW1wb3J0IHtQb2x5Z29uVGVzc2VsYXRvcn0gZnJvbSAnZGVjay5nbC1sYXllcnMvc29saWQtcG9seWdvbi1sYXllci9wb2x5Z29uLXRlc3NlbGF0b3InO1xuXG5jb25zdCBQT0xZR09OUyA9IFtbXSwgW1sxLCAxXV0sIFtbMSwgMV0sIFsxLCAxXSwgWzEsIDFdXSwgW1tbMSwgMV1dXSwgW1tbMSwgMV0sIFsxLCAxXSwgWzEsIDFdXV1dO1xuXG5jb25zdCBURVNUX0RBVEEgPSBbXG4gIHtcbiAgICB0aXRsZTogJ1BsYWluIGFycmF5JyxcbiAgICBwb2x5Z29uczogUE9MWUdPTlNcbiAgfVxuXTtcblxuY29uc3QgVEVTVF9DQVNFUyA9IFtcbiAge1xuICAgIHRpdGxlOiAnVGVzc2VsYXRpb24oZmxhdCknLFxuICAgIHBhcmFtczoge31cbiAgfSxcbiAge1xuICAgIHRpdGxlOiAnVGVzc2VsYXRpb24oZXh0cnVkZWQpJyxcbiAgICBwYXJhbXM6IHtleHRydWRlZDogdHJ1ZX1cbiAgfSxcbiAge1xuICAgIHRpdGxlOiAnVGVzc2VsYXRpb24oZmxhdCxmcDY0KScsXG4gICAgcGFyYW1zOiB7ZnA2NDogdHJ1ZX1cbiAgfSxcbiAge1xuICAgIHRpdGxlOiAnVGVzc2VsYXRpb24oZXh0cnVkZWQsZnA2NCknLFxuICAgIHBhcmFtczoge2V4dHJ1ZGVkOiB0cnVlLCBmcDY0OiB0cnVlfVxuICB9XG5dO1xuXG50ZXN0KCdwb2x5Z29uI2ltcG9ydHMnLCB0ID0+IHtcbiAgdC5vayh0eXBlb2YgUG9seWdvbi5ub3JtYWxpemUgPT09ICdmdW5jdGlvbicsICdQb2x5Z29uLm5vcm1hbGl6ZSBpbXBvcnRlZCcpO1xuICB0Lm9rKHR5cGVvZiBQb2x5Z29uLmdldFZlcnRleENvdW50ID09PSAnZnVuY3Rpb24nLCAnUG9seWdvbi5nZXRWZXJ0ZXhDb3VudCBpbXBvcnRlZCcpO1xuICB0Lm9rKHR5cGVvZiBQb2x5Z29uLmdldFRyaWFuZ2xlQ291bnQgPT09ICdmdW5jdGlvbicsICdQb2x5Z29uLmdldFRyaWFuZ2xlQ291bnQgaW1wb3J0ZWQnKTtcbiAgdC5vayh0eXBlb2YgUG9seWdvbi5mb3JFYWNoVmVydGV4ID09PSAnZnVuY3Rpb24nLCAnUG9seWdvbi5mb3JFYWNoVmVydGV4IGltcG9ydGVkJyk7XG4gIHQuZW5kKCk7XG59KTtcblxudGVzdCgncG9seWdvbiNmdW5jdGlvbnMnLCB0ID0+IHtcbiAgZm9yIChjb25zdCBwb2x5Z29uIG9mIFBPTFlHT05TKSB7XG4gICAgdC5vayhBcnJheS5pc0FycmF5KFBvbHlnb24ubm9ybWFsaXplKHBvbHlnb24pKSwgJ1BvbHlnb24ubm9ybWFsaXplJyk7XG4gICAgdC5vayhOdW1iZXIuaXNGaW5pdGUoUG9seWdvbi5nZXRUcmlhbmdsZUNvdW50KHBvbHlnb24pKSwgJ1BvbHlnb24uZ2V0VHJpYW5nbGVDb3VudCcpO1xuICAgIHQub2soTnVtYmVyLmlzRmluaXRlKFBvbHlnb24uZ2V0VmVydGV4Q291bnQocG9seWdvbikpLCAnUG9seWdvbi5nZXRWZXJ0ZXhDb3VudCcpO1xuICB9XG5cbiAgdC5lbmQoKTtcbn0pO1xuXG50ZXN0KCdwb2x5Z29uVGVzc2VsYXRvciNpbXBvcnRzJywgdCA9PiB7XG4gIHQub2sodHlwZW9mIFBvbHlnb25UZXNzZWxhdG9yID09PSAnZnVuY3Rpb24nLCAnUG9seWdvblRlc3NlbGF0b3IgaW1wb3J0ZWQnKTtcbiAgdC5lbmQoKTtcbn0pO1xuXG50ZXN0KCdQb2x5Z29uVGVzc2VsYXRvciNjb25zdHJ1Y3RvcicsIHQgPT4ge1xuICBURVNUX0RBVEEuZm9yRWFjaCh0ZXN0RGF0YSA9PiB7XG4gICAgdC5jb21tZW50KGBQb2x5Z29uIGRhdGE6ICR7dGVzdERhdGEudGl0bGV9YCk7XG4gICAgY29uc3QgdGVzc2VsYXRvciA9IG5ldyBQb2x5Z29uVGVzc2VsYXRvcih7cG9seWdvbnM6IHRlc3REYXRhLnBvbHlnb25zfSk7XG4gICAgdC5vayh0ZXNzZWxhdG9yIGluc3RhbmNlb2YgUG9seWdvblRlc3NlbGF0b3IsICdQb2x5Z29uVGVzc2VsYXRvciBjcmVhdGVkJyk7XG5cbiAgICBURVNUX0NBU0VTLmZvckVhY2godGVzdENhc2UgPT4ge1xuICAgICAgdC5jb21tZW50KGAgICR7dGVzdENhc2UudGl0bGV9YCk7XG4gICAgICB0ZXNzZWxhdG9yLnVwZGF0ZVBvc2l0aW9ucyh0ZXN0Q2FzZS5wYXJhbXMpO1xuXG4gICAgICB0Lm9rKEFycmF5QnVmZmVyLmlzVmlldyh0ZXNzZWxhdG9yLnBvc2l0aW9ucygpKSwgJ1BvbHlnb25UZXNzZWxhdG9yLnBvc2l0aW9ucycpO1xuICAgICAgdC5vayhBcnJheUJ1ZmZlci5pc1ZpZXcodGVzc2VsYXRvci5uZXh0UG9zaXRpb25zKCkpLCAnUG9seWdvblRlc3NlbGF0b3IubmV4dFBvc2l0aW9ucycpO1xuXG4gICAgICBpZiAodGVzdENhc2UucGFyYW1zLmZwNjQpIHtcbiAgICAgICAgdC5vayhcbiAgICAgICAgICBBcnJheUJ1ZmZlci5pc1ZpZXcodGVzc2VsYXRvci5wb3NpdGlvbnM2NHh5TG93KCkpLFxuICAgICAgICAgICdQb2x5Z29uVGVzc2VsYXRvci5wb3NpdGlvbnM2NHh5TG93J1xuICAgICAgICApO1xuICAgICAgICB0Lm9rKFxuICAgICAgICAgIEFycmF5QnVmZmVyLmlzVmlldyh0ZXNzZWxhdG9yLm5leHRQb3NpdGlvbnM2NHh5TG93KCkpLFxuICAgICAgICAgICdQb2x5Z29uVGVzc2VsYXRvci5uZXh0UG9zaXRpb25zNjR4eUxvdydcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfSk7XG5cbiAgdC5lbmQoKTtcbn0pO1xuXG50ZXN0KCdQb2x5Z29uVGVzc2VsYXRvciNtZXRob2RzJywgdCA9PiB7XG4gIFRFU1RfREFUQS5mb3JFYWNoKHRlc3REYXRhID0+IHtcbiAgICB0LmNvbW1lbnQoYFBvbHlnb24gZGF0YTogJHt0ZXN0RGF0YS50aXRsZX1gKTtcbiAgICBjb25zdCB0ZXNzZWxhdG9yID0gbmV3IFBvbHlnb25UZXNzZWxhdG9yKHtwb2x5Z29uczogdGVzdERhdGEucG9seWdvbnN9KTtcblxuICAgIHQub2soQXJyYXlCdWZmZXIuaXNWaWV3KHRlc3NlbGF0b3IuaW5kaWNlcygpKSwgJ1BvbHlnb25UZXNzZWxhdG9yLmluZGljZXMnKTtcbiAgICB0Lm9rKEFycmF5QnVmZmVyLmlzVmlldyh0ZXNzZWxhdG9yLmNvbG9ycygpKSwgJ1BvbHlnb25UZXNzZWxhdG9yLmNvbG9ycycpO1xuICAgIHQub2soQXJyYXlCdWZmZXIuaXNWaWV3KHRlc3NlbGF0b3IucGlja2luZ0NvbG9ycygpKSwgJ1BvbHlnb25UZXNzZWxhdG9yLnBpY2tpbmdDb2xvcnMnKTtcbiAgfSk7XG5cbiAgdC5lbmQoKTtcbn0pO1xuIl19