'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getUniformsFromViewport = getUniformsFromViewport;

var _multiply = require('gl-mat4/multiply');

var _multiply2 = _interopRequireDefault(_multiply);

var _transformMat = require('gl-vec4/transformMat4');

var _transformMat2 = _interopRequireDefault(_transformMat);

var _log = require('../../utils/log');

var _log2 = _interopRequireDefault(_log);

var _assert = require('assert');

var _assert2 = _interopRequireDefault(_assert);

var _constants = require('../../lib/constants');

var _viewportMercatorProject = require('viewport-mercator-project');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

// To quickly set a vector to zero
// Copyright (c) 2015 - 2017 Uber Technologies, Inc.
//
// Permission is hereby granted, free of charge, to any person obtaining a copy
// of this software and associated documentation files (the "Software"), to deal
// in the Software without restriction, including without limitation the rights
// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
// copies of the Software, and to permit persons to whom the Software is
// furnished to do so, subject to the following conditions:
//
// The above copyright notice and this permission notice shall be included in
// all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
// THE SOFTWARE.

/* global window */
var ZERO_VECTOR = [0, 0, 0, 0];
// 4x4 matrix that drops 4th component of vector
var VECTOR_TO_POINT_MATRIX = [1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0];
var IDENTITY_MATRIX = [1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1];
var DEFAULT_PIXELS_PER_UNIT2 = [0, 0, 0];

// TODO - import these utils from fp64 package
function fp64ify(a) {
  var array = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : [];
  var startIndex = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : 0;

  var hiPart = Math.fround(a);
  var loPart = a - hiPart;
  array[startIndex] = hiPart;
  array[startIndex + 1] = loPart;
  return array;
}

// calculate WebGL 64 bit matrix (transposed "Float64Array")
function fp64ifyMatrix4(matrix) {
  // Transpose the projection matrix to column major for GLSL.
  var matrixFP64 = new Float32Array(32);
  for (var i = 0; i < 4; ++i) {
    for (var j = 0; j < 4; ++j) {
      var index = i * 4 + j;
      fp64ify(matrix[j * 4 + i], matrixFP64, index * 2);
    }
  }
  return matrixFP64;
}

// The code that utilizes Matrix4 does the same calculation as their mat4 counterparts,
// has lower performance but provides error checking.
// Uncomment when debugging
function calculateMatrixAndOffset(_ref) {
  var viewport = _ref.viewport,
      modelMatrix = _ref.modelMatrix,
      coordinateSystem = _ref.coordinateSystem,
      coordinateOrigin = _ref.coordinateOrigin,
      coordinateZoom = _ref.coordinateZoom;
  var viewMatrixUncentered = viewport.viewMatrixUncentered;
  var viewMatrix = viewport.viewMatrix;
  var projectionMatrix = viewport.projectionMatrix;
  var viewProjectionMatrix = viewport.viewProjectionMatrix;


  var projectionCenter = void 0;

  switch (coordinateSystem) {
    case _constants.COORDINATE_SYSTEM.IDENTITY:
    case _constants.COORDINATE_SYSTEM.LNGLAT:
      projectionCenter = ZERO_VECTOR;
      break;

    // TODO: make lighting work for meter offset mode
    case _constants.COORDINATE_SYSTEM.LNGLAT_OFFSETS:
    case _constants.COORDINATE_SYSTEM.METER_OFFSETS:
      // Calculate transformed projectionCenter (using 64 bit precision JS)
      // This is the key to offset mode precision
      // (avoids doing this addition in 32 bit precision in GLSL)
      var positionPixels = (0, _viewportMercatorProject.projectFlat)(coordinateOrigin, Math.pow(2, coordinateZoom));
      // projectionCenter = new Matrix4(viewProjectionMatrix)
      //   .transformVector([positionPixels[0], positionPixels[1], 0.0, 1.0]);
      projectionCenter = (0, _transformMat2.default)([], [positionPixels[0], positionPixels[1], 0.0, 1.0], viewProjectionMatrix);

      // Always apply uncentered projection matrix if available (shader adds center)
      viewMatrix = viewMatrixUncentered || viewMatrix;

      // Zero out 4th coordinate ("after" model matrix) - avoids further translations
      // viewMatrix = new Matrix4(viewMatrixUncentered || viewMatrix)
      //   .multiplyRight(VECTOR_TO_POINT_MATRIX);
      viewProjectionMatrix = (0, _multiply2.default)([], projectionMatrix, viewMatrix);
      viewProjectionMatrix = (0, _multiply2.default)([], viewProjectionMatrix, VECTOR_TO_POINT_MATRIX);
      break;

    default:
      throw new Error('Unknown projection mode');
  }

  return {
    viewMatrix: viewMatrix,
    viewProjectionMatrix: viewProjectionMatrix,
    projectionCenter: projectionCenter,
    cameraPos: viewport.cameraPosition
  };
}

/**
 * Returns uniforms for shaders based on current projection
 * includes: projection matrix suitable for shaders
 *
 * TODO - Ensure this works with any viewport, not just WebMercatorViewports
 *
 * @param {WebMercatorViewport} viewport -
 * @return {Float32Array} - 4x4 projection matrix that can be used in shaders
 */
function getUniformsFromViewport() {
  var _ref2 = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {},
      viewport = _ref2.viewport,
      _ref2$modelMatrix = _ref2.modelMatrix,
      modelMatrix = _ref2$modelMatrix === undefined ? null : _ref2$modelMatrix,
      _ref2$coordinateSyste = _ref2.coordinateSystem,
      coordinateSystem = _ref2$coordinateSyste === undefined ? _constants.COORDINATE_SYSTEM.LNGLAT : _ref2$coordinateSyste,
      _ref2$coordinateOrigi = _ref2.coordinateOrigin,
      coordinateOrigin = _ref2$coordinateOrigi === undefined ? [0, 0] : _ref2$coordinateOrigi,
      _ref2$fp = _ref2.fp64,
      fp64 = _ref2$fp === undefined ? false : _ref2$fp,
      projectionMode = _ref2.projectionMode,
      positionOrigin = _ref2.positionOrigin;

  (0, _assert2.default)(viewport);

  if (projectionMode !== undefined) {
    _log2.default.removed('projectionMode', 'coordinateSystem');
  }
  if (positionOrigin !== undefined) {
    _log2.default.removed('positionOrigin', 'coordinateOrigin');
  }

  var coordinateZoom = viewport.zoom;
  (0, _assert2.default)(coordinateZoom >= 0);

  var _calculateMatrixAndOf = calculateMatrixAndOffset({
    coordinateSystem: coordinateSystem,
    coordinateOrigin: coordinateOrigin,
    coordinateZoom: coordinateZoom,
    modelMatrix: modelMatrix,
    viewport: viewport
  }),
      projectionCenter = _calculateMatrixAndOf.projectionCenter,
      viewProjectionMatrix = _calculateMatrixAndOf.viewProjectionMatrix,
      cameraPos = _calculateMatrixAndOf.cameraPos;

  (0, _assert2.default)(viewProjectionMatrix, 'Viewport missing modelViewProjectionMatrix');

  // Calculate projection pixels per unit
  var distanceScales = viewport.getDistanceScales();

  // TODO - does this depend on useDevicePixels?
  var devicePixelRatio = window && window.devicePixelRatio || 1;
  var viewportSize = [viewport.width * devicePixelRatio, viewport.height * devicePixelRatio];

  var glModelMatrix = modelMatrix || IDENTITY_MATRIX;

  var uniforms = {
    // Projection mode values
    project_uCoordinateSystem: coordinateSystem,
    project_uCenter: projectionCenter,

    // Screen size
    project_uViewportSize: viewportSize,
    project_uDevicePixelRatio: devicePixelRatio,

    // Distance at which screen pixels are projected
    project_uFocalDistance: viewport.focalDistance || 1,
    project_uPixelsPerMeter: distanceScales.pixelsPerMeter,
    project_uPixelsPerDegree: distanceScales.pixelsPerDegree,
    project_uPixelsPerUnit: distanceScales.pixelsPerMeter,
    project_uPixelsPerUnit2: DEFAULT_PIXELS_PER_UNIT2,
    project_uScale: viewport.scale, // This is the mercator scale (2 ** zoom)

    project_uModelMatrix: glModelMatrix,
    project_uViewProjectionMatrix: viewProjectionMatrix,

    // This is for lighting calculations
    project_uCameraPosition: cameraPos
  };

  if (coordinateSystem === _constants.COORDINATE_SYSTEM.METER_OFFSETS) {
    var distanceScalesAtOrigin = viewport.getDistanceScales(coordinateOrigin);
    uniforms.project_uPixelsPerUnit = distanceScalesAtOrigin.pixelsPerMeter;
    uniforms.project_uPixelsPerUnit2 = distanceScalesAtOrigin.pixelsPerMeter2;
  }
  if (coordinateSystem === _constants.COORDINATE_SYSTEM.LNGLAT_OFFSETS) {
    var _distanceScalesAtOrigin = viewport.getDistanceScales(coordinateOrigin);
    uniforms.project_uPixelsPerUnit = _distanceScalesAtOrigin.pixelsPerDegree;
    uniforms.project_uPixelsPerUnit2 = _distanceScalesAtOrigin.pixelsPerDegree2;
  }

  // TODO - fp64 flag should be from shader module, not layer props
  return fp64 ? addFP64Uniforms(uniforms) : uniforms;
}

// 64 bit projection support
function addFP64Uniforms(uniforms) {
  var glViewProjectionMatrixFP64 = fp64ifyMatrix4(uniforms.project_uViewProjectionMatrix);
  var scaleFP64 = fp64ify(uniforms.project_uScale);

  uniforms.project_uViewProjectionMatrixFP64 = glViewProjectionMatrixFP64;
  uniforms.project64_uViewProjectionMatrix = glViewProjectionMatrixFP64;
  uniforms.project64_uScale = scaleFP64;

  return uniforms;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb3JlL3NoYWRlcmxpYi9wcm9qZWN0L3ZpZXdwb3J0LXVuaWZvcm1zLmpzIl0sIm5hbWVzIjpbImdldFVuaWZvcm1zRnJvbVZpZXdwb3J0IiwiWkVST19WRUNUT1IiLCJWRUNUT1JfVE9fUE9JTlRfTUFUUklYIiwiSURFTlRJVFlfTUFUUklYIiwiREVGQVVMVF9QSVhFTFNfUEVSX1VOSVQyIiwiZnA2NGlmeSIsImEiLCJhcnJheSIsInN0YXJ0SW5kZXgiLCJoaVBhcnQiLCJNYXRoIiwiZnJvdW5kIiwibG9QYXJ0IiwiZnA2NGlmeU1hdHJpeDQiLCJtYXRyaXgiLCJtYXRyaXhGUDY0IiwiRmxvYXQzMkFycmF5IiwiaSIsImoiLCJpbmRleCIsImNhbGN1bGF0ZU1hdHJpeEFuZE9mZnNldCIsInZpZXdwb3J0IiwibW9kZWxNYXRyaXgiLCJjb29yZGluYXRlU3lzdGVtIiwiY29vcmRpbmF0ZU9yaWdpbiIsImNvb3JkaW5hdGVab29tIiwidmlld01hdHJpeFVuY2VudGVyZWQiLCJ2aWV3TWF0cml4IiwicHJvamVjdGlvbk1hdHJpeCIsInZpZXdQcm9qZWN0aW9uTWF0cml4IiwicHJvamVjdGlvbkNlbnRlciIsIklERU5USVRZIiwiTE5HTEFUIiwiTE5HTEFUX09GRlNFVFMiLCJNRVRFUl9PRkZTRVRTIiwicG9zaXRpb25QaXhlbHMiLCJwb3ciLCJFcnJvciIsImNhbWVyYVBvcyIsImNhbWVyYVBvc2l0aW9uIiwiZnA2NCIsInByb2plY3Rpb25Nb2RlIiwicG9zaXRpb25PcmlnaW4iLCJ1bmRlZmluZWQiLCJyZW1vdmVkIiwiem9vbSIsImRpc3RhbmNlU2NhbGVzIiwiZ2V0RGlzdGFuY2VTY2FsZXMiLCJkZXZpY2VQaXhlbFJhdGlvIiwid2luZG93Iiwidmlld3BvcnRTaXplIiwid2lkdGgiLCJoZWlnaHQiLCJnbE1vZGVsTWF0cml4IiwidW5pZm9ybXMiLCJwcm9qZWN0X3VDb29yZGluYXRlU3lzdGVtIiwicHJvamVjdF91Q2VudGVyIiwicHJvamVjdF91Vmlld3BvcnRTaXplIiwicHJvamVjdF91RGV2aWNlUGl4ZWxSYXRpbyIsInByb2plY3RfdUZvY2FsRGlzdGFuY2UiLCJmb2NhbERpc3RhbmNlIiwicHJvamVjdF91UGl4ZWxzUGVyTWV0ZXIiLCJwaXhlbHNQZXJNZXRlciIsInByb2plY3RfdVBpeGVsc1BlckRlZ3JlZSIsInBpeGVsc1BlckRlZ3JlZSIsInByb2plY3RfdVBpeGVsc1BlclVuaXQiLCJwcm9qZWN0X3VQaXhlbHNQZXJVbml0MiIsInByb2plY3RfdVNjYWxlIiwic2NhbGUiLCJwcm9qZWN0X3VNb2RlbE1hdHJpeCIsInByb2plY3RfdVZpZXdQcm9qZWN0aW9uTWF0cml4IiwicHJvamVjdF91Q2FtZXJhUG9zaXRpb24iLCJkaXN0YW5jZVNjYWxlc0F0T3JpZ2luIiwicGl4ZWxzUGVyTWV0ZXIyIiwicGl4ZWxzUGVyRGVncmVlMiIsImFkZEZQNjRVbmlmb3JtcyIsImdsVmlld1Byb2plY3Rpb25NYXRyaXhGUDY0Iiwic2NhbGVGUDY0IiwicHJvamVjdF91Vmlld1Byb2plY3Rpb25NYXRyaXhGUDY0IiwicHJvamVjdDY0X3VWaWV3UHJvamVjdGlvbk1hdHJpeCIsInByb2plY3Q2NF91U2NhbGUiXSwibWFwcGluZ3MiOiI7Ozs7O1FBa0lnQkEsdUIsR0FBQUEsdUI7O0FBN0doQjs7OztBQUNBOzs7O0FBRUE7Ozs7QUFDQTs7OztBQUNBOztBQUVBOzs7O0FBRUE7QUE5QkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFXQSxJQUFNQyxjQUFjLENBQUMsQ0FBRCxFQUFJLENBQUosRUFBTyxDQUFQLEVBQVUsQ0FBVixDQUFwQjtBQUNBO0FBQ0EsSUFBTUMseUJBQXlCLENBQUMsQ0FBRCxFQUFJLENBQUosRUFBTyxDQUFQLEVBQVUsQ0FBVixFQUFhLENBQWIsRUFBZ0IsQ0FBaEIsRUFBbUIsQ0FB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QkFBdUJWLGNBQXpEO0FBQ0FSLGFBQVNZLHVCQUFULEdBQW1DTSx1QkFBdUJDLGVBQTFEO0FBQ0Q7QUFDRCxNQUFJbEQscUJBQXFCLDZCQUFrQlUsY0FBM0MsRUFBMkQ7QUFDekQsUUFBTXVDLDBCQUF5Qm5ELFNBQVMwQixpQkFBVCxDQUEyQnZCLGdCQUEzQixDQUEvQjtBQUNBOEIsYUFBU1csc0JBQVQsR0FBa0NPLHdCQUF1QlIsZUFBekQ7QUFDQVYsYUFBU1ksdUJBQVQsR0FBbUNNLHdCQUF1QkUsZ0JBQTFEO0FBQ0Q7O0FBRUQ7QUFDQSxTQUFPbEMsT0FBT21DLGdCQUFnQnJCLFFBQWhCLENBQVAsR0FBbUNBLFFBQTFDO0FBQ0Q7O0FBRUQ7QUFDQSxTQUFTcUIsZUFBVCxDQUF5QnJCLFFBQXpCLEVBQW1DO0FBQ2pDLE1BQU1zQiw2QkFBNkIvRCxlQUFleUMsU0FBU2dCLDZCQUF4QixDQUFuQztBQUNBLE1BQU1PLFlBQVl4RSxRQUFRaUQsU0FBU2EsY0FBakIsQ0FBbEI7O0FBRUFiLFdBQVN3QixpQ0FBVCxHQUE2Q0YsMEJBQTdDO0FBQ0F0QixXQUFTeUIsK0JBQVQsR0FBMkNILDBCQUEzQztBQUNBdEIsV0FBUzBCLGdCQUFULEdBQTRCSCxTQUE1Qjs7QUFFQSxTQUFPdkIsUUFBUDtBQUNEIiwiZmlsZSI6InZpZXdwb3J0LXVuaWZvcm1zLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IChjKSAyMDE1IC0gMjAxNyBVYmVyIFRlY2hub2xvZ2llcywgSW5jLlxuLy9cbi8vIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHlcbi8vIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlIFwiU29mdHdhcmVcIiksIHRvIGRlYWxcbi8vIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHNcbi8vIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGxcbi8vIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpc1xuLy8gZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczpcbi8vXG4vLyBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpblxuLy8gYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuXG4vL1xuLy8gVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEIFwiQVMgSVNcIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUyBPUlxuLy8gSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksXG4vLyBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTCBUSEVcbi8vIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVJcbi8vIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HIEZST00sXG4vLyBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOXG4vLyBUSEUgU09GVFdBUkUuXG5cbi8qIGdsb2JhbCB3aW5kb3cgKi9cbmltcG9ydCBtYXQ0X211bHRpcGx5IGZyb20gJ2dsLW1hdDQvbXVsdGlwbHknO1xuaW1wb3J0IHZlYzRfdHJhbnNmb3JtTWF0NCBmcm9tICdnbC12ZWM0L3RyYW5zZm9ybU1hdDQnO1xuXG5pbXBvcnQgbG9nIGZyb20gJy4uLy4uL3V0aWxzL2xvZyc7XG5pbXBvcnQgYXNzZXJ0IGZyb20gJ2Fzc2VydCc7XG5pbXBvcnQge0NPT1JESU5BVEVfU1lTVEVNfSBmcm9tICcuLi8uLi9saWIvY29uc3RhbnRzJztcblxuaW1wb3J0IHtwcm9qZWN0RmxhdH0gZnJvbSAndmlld3BvcnQtbWVyY2F0b3ItcHJvamVjdCc7XG5cbi8vIFRvIHF1aWNrbHkgc2V0IGEgdmVjdG9yIHRvIHplcm9cbmNvbnN0IFpFUk9fVkVDVE9SID0gWzAsIDAsIDAsIDBdO1xuLy8gNHg0IG1hdHJpeCB0aGF0IGRyb3BzIDR0aCBjb21wb25lbnQgb2YgdmVjdG9yXG5jb25zdCBWRUNUT1JfVE9fUE9JTlRfTUFUUklYID0gWzEsIDAsIDAsIDAsIDAsIDEsIDAsIDAsIDAsIDAsIDEsIDAsIDAsIDAsIDAsIDBdO1xuY29uc3QgSURFTlRJVFlfTUFUUklYID0gWzEsIDAsIDAsIDAsIDAsIDEsIDAsIDAsIDAsIDAsIDEsIDAsIDAsIDAsIDAsIDFdO1xuY29uc3QgREVGQVVMVF9QSVhFTFNfUEVSX1VOSVQyID0gWzAsIDAsIDBdO1xuXG4vLyBUT0RPIC0gaW1wb3J0IHRoZXNlIHV0aWxzIGZyb20gZnA2NCBwYWNrYWdlXG5mdW5jdGlvbiBmcDY0aWZ5KGEsIGFycmF5ID0gW10sIHN0YXJ0SW5kZXggPSAwKSB7XG4gIGNvbnN0IGhpUGFydCA9IE1hdGguZnJvdW5kKGEpO1xuICBjb25zdCBsb1BhcnQgPSBhIC0gaGlQYXJ0O1xuICBhcnJheVtzdGFydEluZGV4XSA9IGhpUGFydDtcbiAgYXJyYXlbc3RhcnRJbmRleCArIDFdID0gbG9QYXJ0O1xuICByZXR1cm4gYXJyYXk7XG59XG5cbi8vIGNhbGN1bGF0ZSBXZWJHTCA2NCBiaXQgbWF0cml4ICh0cmFuc3Bvc2VkIFwiRmxvYXQ2NEFycmF5XCIpXG5mdW5jdGlvbiBmcDY0aWZ5TWF0cml4NChtYXRyaXgpIHtcbiAgLy8gVHJhbnNwb3NlIHRoZSBwcm9qZWN0aW9uIG1hdHJpeCB0byBjb2x1bW4gbWFqb3IgZm9yIEdMU0wuXG4gIGNvbnN0IG1hdHJpeEZQNjQgPSBuZXcgRmxvYXQzMkFycmF5KDMyKTtcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCA0OyArK2kpIHtcbiAgICBmb3IgKGxldCBqID0gMDsgaiA8IDQ7ICsraikge1xuICAgICAgY29uc3QgaW5kZXggPSBpICogNCArIGo7XG4gICAgICBmcDY0aWZ5KG1hdHJpeFtqICogNCArIGldLCBtYXRyaXhGUDY0LCBpbmRleCAqIDIpO1xuICAgIH1cbiAgfVxuICByZXR1cm4gbWF0cml4RlA2NDtcbn1cblxuLy8gVGhlIGNvZGUgdGhhdCB1dGlsaXplcyBNYXRyaXg0IGRvZXMgdGhlIHNhbWUgY2FsY3VsYXRpb24gYXMgdGhlaXIgbWF0NCBjb3VudGVycGFydHMsXG4vLyBoYXMgbG93ZXIgcGVyZm9ybWFuY2UgYnV0IHByb3ZpZGVzIGVycm9yIGNoZWNraW5nLlxuLy8gVW5jb21tZW50IHdoZW4gZGVidWdnaW5nXG5mdW5jdGlvbiBjYWxjdWxhdGVNYXRyaXhBbmRPZmZzZXQoe1xuICAvLyBVTkNIQU5HRURcbiAgdmlld3BvcnQsXG4gIG1vZGVsTWF0cml4LFxuICAvLyBORVcgUEFSQU1TXG4gIGNvb3JkaW5hdGVTeXN0ZW0sXG4gIGNvb3JkaW5hdGVPcmlnaW4sXG4gIGNvb3JkaW5hdGVab29tXG59KSB7XG4gIGNvbnN0IHt2aWV3TWF0cml4VW5jZW50ZXJlZH0gPSB2aWV3cG9ydDtcbiAgbGV0IHt2aWV3TWF0cml4fSA9IHZpZXdwb3J0O1xuICBjb25zdCB7cHJvamVjdGlvbk1hdHJpeH0gPSB2aWV3cG9ydDtcbiAgbGV0IHt2aWV3UHJvamVjdGlvbk1hdHJpeH0gPSB2aWV3cG9ydDtcblxuICBsZXQgcHJvamVjdGlvbkNlbnRlcjtcblxuICBzd2l0Y2ggKGNvb3JkaW5hdGVTeXN0ZW0pIHtcbiAgICBjYXNlIENPT1JESU5BVEVfU1lTVEVNLklERU5USVRZOlxuICAgIGNhc2UgQ09PUkRJTkFURV9TWVNURU0uTE5HTEFUOlxuICAgICAgcHJvamVjdGlvbkNlbnRlciA9IFpFUk9fVkVDVE9SO1xuICAgICAgYnJlYWs7XG5cbiAgICAvLyBUT0RPOiBtYWtlIGxpZ2h0aW5nIHdvcmsgZm9yIG1ldGVyIG9mZnNldCBtb2RlXG4gICAgY2FzZSBDT09SRElOQVRFX1NZU1RFTS5MTkdMQVRfT0ZGU0VUUzpcbiAgICBjYXNlIENPT1JESU5BVEVfU1lTVEVNLk1FVEVSX09GRlNFVFM6XG4gICAgICAvLyBDYWxjdWxhdGUgdHJhbnNmb3JtZWQgcHJvamVjdGlvbkNlbnRlciAodXNpbmcgNjQgYml0IHByZWNpc2lvbiBKUylcbiAgICAgIC8vIFRoaXMgaXMgdGhlIGtleSB0byBvZmZzZXQgbW9kZSBwcmVjaXNpb25cbiAgICAgIC8vIChhdm9pZHMgZG9pbmcgdGhpcyBhZGRpdGlvbiBpbiAzMiBiaXQgcHJlY2lzaW9uIGluIEdMU0wpXG4gICAgICBjb25zdCBwb3NpdGlvblBpeGVscyA9IHByb2plY3RGbGF0KGNvb3JkaW5hdGVPcmlnaW4sIE1hdGgucG93KDIsIGNvb3JkaW5hdGVab29tKSk7XG4gICAgICAvLyBwcm9qZWN0aW9uQ2VudGVyID0gbmV3IE1hdHJpeDQodmlld1Byb2plY3Rpb25NYXRyaXgpXG4gICAgICAvLyAgIC50cmFuc2Zvcm1WZWN0b3IoW3Bvc2l0aW9uUGl4ZWxzWzBdLCBwb3NpdGlvblBpeGVsc1sxXSwgMC4wLCAxLjBdKTtcbiAgICAgIHByb2plY3Rpb25DZW50ZXIgPSB2ZWM0X3RyYW5zZm9ybU1hdDQoXG4gICAgICAgIFtdLFxuICAgICAgICBbcG9zaXRpb25QaXhlbHNbMF0sIHBvc2l0aW9uUGl4ZWxzWzFdLCAwLjAsIDEuMF0sXG4gICAgICAgIHZpZXdQcm9qZWN0aW9uTWF0cml4XG4gICAgICApO1xuXG4gICAgICAvLyBBbHdheXMgYXBwbHkgdW5jZW50ZXJlZCBwcm9qZWN0aW9uIG1hdHJpeCBpZiBhdmFpbGFibGUgKHNoYWRlciBhZGRzIGNlbnRlcilcbiAgICAgIHZpZXdNYXRyaXggPSB2aWV3TWF0cml4VW5jZW50ZXJlZCB8fCB2aWV3TWF0cml4O1xuXG4gICAgICAvLyBaZXJvIG91dCA0dGggY29vcmRpbmF0ZSAoXCJhZnRlclwiIG1vZGVsIG1hdHJpeCkgLSBhdm9pZHMgZnVydGhlciB0cmFuc2xhdGlvbnNcbiAgICAgIC8vIHZpZXdNYXRyaXggPSBuZXcgTWF0cml4NCh2aWV3TWF0cml4VW5jZW50ZXJlZCB8fCB2aWV3TWF0cml4KVxuICAgICAgLy8gICAubXVsdGlwbHlSaWdodChWRUNUT1JfVE9fUE9JTlRfTUFUUklYKTtcbiAgICAgIHZpZXdQcm9qZWN0aW9uTWF0cml4ID0gbWF0NF9tdWx0aXBseShbXSwgcHJvamVjdGlvbk1hdHJpeCwgdmlld01hdHJpeCk7XG4gICAgICB2aWV3UHJvamVjdGlvbk1hdHJpeCA9IG1hdDRfbXVsdGlwbHkoW10sIHZpZXdQcm9qZWN0aW9uTWF0cml4LCBWRUNUT1JfVE9fUE9JTlRfTUFUUklYKTtcbiAgICAgIGJyZWFrO1xuXG4gICAgZGVmYXVsdDpcbiAgICAgIHRocm93IG5ldyBFcnJvcignVW5rbm93biBwcm9qZWN0aW9uIG1vZGUnKTtcbiAgfVxuXG4gIHJldHVybiB7XG4gICAgdmlld01hdHJpeCxcbiAgICB2aWV3UHJvamVjdGlvbk1hdHJpeCxcbiAgICBwcm9qZWN0aW9uQ2VudGVyLFxuICAgIGNhbWVyYVBvczogdmlld3BvcnQuY2FtZXJhUG9zaXRpb25cbiAgfTtcbn1cblxuLyoqXG4gKiBSZXR1cm5zIHVuaWZvcm1zIGZvciBzaGFkZXJzIGJhc2VkIG9uIGN1cnJlbnQgcHJvamVjdGlvblxuICogaW5jbHVkZXM6IHByb2plY3Rpb24gbWF0cml4IHN1aXRhYmxlIGZvciBzaGFkZXJzXG4gKlxuICogVE9ETyAtIEVuc3VyZSB0aGlzIHdvcmtzIHdpdGggYW55IHZpZXdwb3J0LCBub3QganVzdCBXZWJNZXJjYXRvclZpZXdwb3J0c1xuICpcbiAqIEBwYXJhbSB7V2ViTWVyY2F0b3JWaWV3cG9ydH0gdmlld3BvcnQgLVxuICogQHJldHVybiB7RmxvYXQzMkFycmF5fSAtIDR4NCBwcm9qZWN0aW9uIG1hdHJpeCB0aGF0IGNhbiBiZSB1c2VkIGluIHNoYWRlcnNcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGdldFVuaWZvcm1zRnJvbVZpZXdwb3J0KHtcbiAgdmlld3BvcnQsXG4gIG1vZGVsTWF0cml4ID0gbnVsbCxcbiAgY29vcmRpbmF0ZVN5c3RlbSA9IENPT1JESU5BVEVfU1lTVEVNLkxOR0xBVCxcbiAgY29vcmRpbmF0ZU9yaWdpbiA9IFswLCAwXSxcbiAgZnA2NCA9IGZhbHNlLFxuICAvLyBEZXByZWNhdGVkXG4gIHByb2plY3Rpb25Nb2RlLFxuICBwb3NpdGlvbk9yaWdpblxufSA9IHt9KSB7XG4gIGFzc2VydCh2aWV3cG9ydCk7XG5cbiAgaWYgKHByb2plY3Rpb25Nb2RlICE9PSB1bmRlZmluZWQpIHtcbiAgICBsb2cucmVtb3ZlZCgncHJvamVjdGlvbk1vZGUnLCAnY29vcmRpbmF0ZVN5c3RlbScpO1xuICB9XG4gIGlmIChwb3NpdGlvbk9yaWdpbiAhPT0gdW5kZWZpbmVkKSB7XG4gICAgbG9nLnJlbW92ZWQoJ3Bvc2l0aW9uT3JpZ2luJywgJ2Nvb3JkaW5hdGVPcmlnaW4nKTtcbiAgfVxuXG4gIGNvbnN0IGNvb3JkaW5hdGVab29tID0gdmlld3BvcnQuem9vbTtcbiAgYXNzZXJ0KGNvb3JkaW5hdGVab29tID49IDApO1xuXG4gIGNvbnN0IHtwcm9qZWN0aW9uQ2VudGVyLCB2aWV3UHJvamVjdGlvbk1hdHJpeCwgY2FtZXJhUG9zfSA9IGNhbGN1bGF0ZU1hdHJpeEFuZE9mZnNldCh7XG4gICAgY29vcmRpbmF0ZVN5c3RlbSxcbiAgICBjb29yZGluYXRlT3JpZ2luLFxuICAgIGNvb3JkaW5hdGVab29tLFxuICAgIG1vZGVsTWF0cml4LFxuICAgIHZpZXdwb3J0XG4gIH0pO1xuXG4gIGFzc2VydCh2aWV3UHJvamVjdGlvbk1hdHJpeCwgJ1ZpZXdwb3J0IG1pc3NpbmcgbW9kZWxWaWV3UHJvamVjdGlvbk1hdHJpeCcpO1xuXG4gIC8vIENhbGN1bGF0ZSBwcm9qZWN0aW9uIHBpeGVscyBwZXIgdW5pdFxuICBjb25zdCBkaXN0YW5jZVNjYWxlcyA9IHZpZXdwb3J0LmdldERpc3RhbmNlU2NhbGVzKCk7XG5cbiAgLy8gVE9ETyAtIGRvZXMgdGhpcyBkZXBlbmQgb24gdXNlRGV2aWNlUGl4ZWxzP1xuICBjb25zdCBkZXZpY2VQaXhlbFJhdGlvID0gKHdpbmRvdyAmJiB3aW5kb3cuZGV2aWNlUGl4ZWxSYXRpbykgfHwgMTtcbiAgY29uc3Qgdmlld3BvcnRTaXplID0gW3ZpZXdwb3J0LndpZHRoICogZGV2aWNlUGl4ZWxSYXRpbywgdmlld3BvcnQuaGVpZ2h0ICogZGV2aWNlUGl4ZWxSYXRpb107XG5cbiAgY29uc3QgZ2xNb2RlbE1hdHJpeCA9IG1vZGVsTWF0cml4IHx8IElERU5USVRZX01BVFJJWDtcblxuICBjb25zdCB1bmlmb3JtcyA9IHtcbiAgICAvLyBQcm9qZWN0aW9uIG1vZGUgdmFsdWVzXG4gICAgcHJvamVjdF91Q29vcmRpbmF0ZVN5c3RlbTogY29vcmRpbmF0ZVN5c3RlbSxcbiAgICBwcm9qZWN0X3VDZW50ZXI6IHByb2plY3Rpb25DZW50ZXIsXG5cbiAgICAvLyBTY3JlZW4gc2l6ZVxuICAgIHByb2plY3RfdVZpZXdwb3J0U2l6ZTogdmlld3BvcnRTaXplLFxuICAgIHByb2plY3RfdURldmljZVBpeGVsUmF0aW86IGRldmljZVBpeGVsUmF0aW8sXG5cbiAgICAvLyBEaXN0YW5jZSBhdCB3aGljaCBzY3JlZW4gcGl4ZWxzIGFyZSBwcm9qZWN0ZWRcbiAgICBwcm9qZWN0X3VGb2NhbERpc3RhbmNlOiB2aWV3cG9ydC5mb2NhbERpc3RhbmNlIHx8IDEsXG4gICAgcHJvamVjdF91UGl4ZWxzUGVyTWV0ZXI6IGRpc3RhbmNlU2NhbGVzLnBpeGVsc1Blck1ldGVyLFxuICAgIHByb2plY3RfdVBpeGVsc1BlckRlZ3JlZTogZGlzdGFuY2VTY2FsZXMucGl4ZWxzUGVyRGVncmVlLFxuICAgIHByb2plY3RfdVBpeGVsc1BlclVuaXQ6IGRpc3RhbmNlU2NhbGVzLnBpeGVsc1Blck1ldGVyLFxuICAgIHByb2plY3RfdVBpeGVsc1BlclVuaXQyOiBERUZBVUxUX1BJWEVMU19QRVJfVU5JVDIsXG4gICAgcHJvamVjdF91U2NhbGU6IHZpZXdwb3J0LnNjYWxlLCAvLyBUaGlzIGlzIHRoZSBtZXJjYXRvciBzY2FsZSAoMiAqKiB6b29tKVxuXG4gICAgcHJvamVjdF91TW9kZWxNYXRyaXg6IGdsTW9kZWxNYXRyaXgsXG4gICAgcHJvamVjdF91Vmlld1Byb2plY3Rpb25NYXRyaXg6IHZpZXdQcm9qZWN0aW9uTWF0cml4LFxuXG4gICAgLy8gVGhpcyBpcyBmb3IgbGlnaHRpbmcgY2FsY3VsYXRpb25zXG4gICAgcHJvamVjdF91Q2FtZXJhUG9zaXRpb246IGNhbWVyYVBvc1xuICB9O1xuXG4gIGlmIChjb29yZGluYXRlU3lzdGVtID09PSBDT09SRElOQVRFX1NZU1RFTS5NRVRFUl9PRkZTRVRTKSB7XG4gICAgY29uc3QgZGlzdGFuY2VTY2FsZXNBdE9yaWdpbiA9IHZpZXdwb3J0LmdldERpc3RhbmNlU2NhbGVzKGNvb3JkaW5hdGVPcmlnaW4pO1xuICAgIHVuaWZvcm1zLnByb2plY3RfdVBpeGVsc1BlclVuaXQgPSBkaXN0YW5jZVNjYWxlc0F0T3JpZ2luLnBpeGVsc1Blck1ldGVyO1xuICAgIHVuaWZvcm1zLnByb2plY3RfdVBpeGVsc1BlclVuaXQyID0gZGlzdGFuY2VTY2FsZXNBdE9yaWdpbi5waXhlbHNQZXJNZXRlcjI7XG4gIH1cbiAgaWYgKGNvb3JkaW5hdGVTeXN0ZW0gPT09IENPT1JESU5BVEVfU1lTVEVNLkxOR0xBVF9PRkZTRVRTKSB7XG4gICAgY29uc3QgZGlzdGFuY2VTY2FsZXNBdE9yaWdpbiA9IHZpZXdwb3J0LmdldERpc3RhbmNlU2NhbGVzKGNvb3JkaW5hdGVPcmlnaW4pO1xuICAgIHVuaWZvcm1zLnByb2plY3RfdVBpeGVsc1BlclVuaXQgPSBkaXN0YW5jZVNjYWxlc0F0T3JpZ2luLnBpeGVsc1BlckRlZ3JlZTtcbiAgICB1bmlmb3Jtcy5wcm9qZWN0X3VQaXhlbHNQZXJVbml0MiA9IGRpc3RhbmNlU2NhbGVzQXRPcmlnaW4ucGl4ZWxzUGVyRGVncmVlMjtcbiAgfVxuXG4gIC8vIFRPRE8gLSBmcDY0IGZsYWcgc2hvdWxkIGJlIGZyb20gc2hhZGVyIG1vZHVsZSwgbm90IGxheWVyIHByb3BzXG4gIHJldHVybiBmcDY0ID8gYWRkRlA2NFVuaWZvcm1zKHVuaWZvcm1zKSA6IHVuaWZvcm1zO1xufVxuXG4vLyA2NCBiaXQgcHJvamVjdGlvbiBzdXBwb3J0XG5mdW5jdGlvbiBhZGRGUDY0VW5pZm9ybXModW5pZm9ybXMpIHtcbiAgY29uc3QgZ2xWaWV3UHJvamVjdGlvbk1hdHJpeEZQNjQgPSBmcDY0aWZ5TWF0cml4NCh1bmlmb3Jtcy5wcm9qZWN0X3VWaWV3UHJvamVjdGlvbk1hdHJpeCk7XG4gIGNvbnN0IHNjYWxlRlA2NCA9IGZwNjRpZnkodW5pZm9ybXMucHJvamVjdF91U2NhbGUpO1xuXG4gIHVuaWZvcm1zLnByb2plY3RfdVZpZXdQcm9qZWN0aW9uTWF0cml4RlA2NCA9IGdsVmlld1Byb2plY3Rpb25NYXRyaXhGUDY0O1xuICB1bmlmb3Jtcy5wcm9qZWN0NjRfdVZpZXdQcm9qZWN0aW9uTWF0cml4ID0gZ2xWaWV3UHJvamVjdGlvbk1hdHJpeEZQNjQ7XG4gIHVuaWZvcm1zLnByb2plY3Q2NF91U2NhbGUgPSBzY2FsZUZQNjQ7XG5cbiAgcmV0dXJuIHVuaWZvcm1zO1xufVxuIl19