{"version":3,"sources":["../../src/core/animation-loop.js"],"names":["requestAnimationFrame","cancelAnimationFrame","callback","window","setTimeout","timerId","clearTimeout","AnimationLoop","onCreateContext","opts","onDeleteContext","gl","onInitialize","onRender","onFinalize","glOptions","preserveDrawingBuffer","width","height","createFramebuffer","autoResizeViewport","autoResizeCanvas","autoResizeDrawingBuffer","useDevicePixelRatio","useDevicePixels","start","bind","stop","_renderFrame","deprecated","setViewParameters","_onCreateContext","_createFramebuffer","_onInitialize","_onRender","_onFinalize","_stopped","_animationFrameId","_startPromise","then","_createWebGLContext","_initializeCallbackData","_updateCallbackData","_resizeCanvasDrawingBuffer","_resizeViewport","_callbackData","_addCallbackData","appContext","_finalizeCallbackData","_onSetupFrame","_resizeFramebuffer","_setupFrame","tick","canvas","framebuffer","tock","aspect","Object","assign","Error","viewport","resize"],"mappings":"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","file":"animation-loop.js","sourcesContent":["/* global window, setTimeout, clearTimeout */\nimport {isBrowser, log} from '../utils';\nimport {getPageLoadPromise, resizeDrawingBuffer} from '../webgl-utils';\nimport {createGLContext, deleteGLContext, isWebGL, resetParameters} from '../webgl';\nimport {Framebuffer} from '../webgl';\n\n// Node.js polyfills for requestAnimationFrame and cancelAnimationFrame\nexport function requestAnimationFrame(callback) {\n  return isBrowser ? window.requestAnimationFrame(callback) : setTimeout(callback, 1000 / 60);\n}\n\nexport function cancelAnimationFrame(timerId) {\n  return isBrowser ? window.cancelAnimationFrame(timerId) : clearTimeout(timerId);\n}\n\nexport default class AnimationLoop {\n  /*\n   * @param {HTMLCanvasElement} canvas - if provided, width and height will be passed to context\n   */\n  constructor({\n    onCreateContext = opts => createGLContext(opts),\n    onDeleteContext = gl => deleteGLContext(gl),\n    onInitialize = () => {},\n    onRender = () => {},\n    onFinalize = () => {},\n\n    gl = null,\n    glOptions = {\n      preserveDrawingBuffer: true\n    },\n    width = null,\n    height = null,\n\n    createFramebuffer = false,\n\n    // view parameters - can be changed for each start call\n    autoResizeViewport = true,\n    autoResizeCanvas = true,\n    autoResizeDrawingBuffer = true,\n    useDevicePixelRatio = null, // deprecated\n    useDevicePixels = true\n  } = {}) {\n    this.start = this.start.bind(this);\n    this.stop = this.stop.bind(this);\n    this._renderFrame = this._renderFrame.bind(this);\n\n    if (useDevicePixelRatio !== null) {\n      log.deprecated('useDevicePixelRatio', 'useDevicePixels');\n      useDevicePixels = useDevicePixelRatio;\n    }\n\n    this.setViewParameters({\n      autoResizeViewport,\n      autoResizeCanvas,\n      autoResizeDrawingBuffer,\n      useDevicePixels\n    });\n\n    this._onCreateContext = onCreateContext;\n    this.glOptions = glOptions;\n    this._createFramebuffer = createFramebuffer;\n\n    this._onInitialize = onInitialize;\n    this._onRender = onRender;\n    this._onFinalize = onFinalize;\n\n    this.width = width;\n    this.height = height;\n\n    this.gl = gl;\n\n    return this;\n  }\n\n  // Update parameters (TODO - should these be specified in `start`?)\n  setViewParameters({\n    autoResizeDrawingBuffer = true,\n    autoResizeCanvas = true,\n    autoResizeViewport = true,\n    useDevicePixels = true,\n    useDevicePixelRatio = null // deprecated\n  }) {\n    this.autoResizeViewport = autoResizeViewport;\n    this.autoResizeCanvas = autoResizeCanvas;\n    this.autoResizeDrawingBuffer = autoResizeDrawingBuffer;\n    this.useDevicePixels = useDevicePixels;\n    if (useDevicePixelRatio !== null) {\n      log.deprecated('useDevicePixelRatio', 'useDevicePixels');\n      this.useDevicePixels = useDevicePixelRatio;\n    }\n    return this;\n  }\n\n  // Starts a render loop if not already running\n  // @param {Object} context - contains frame specific info (E.g. tick, width, height, etc)\n  start(opts = {}) {\n    this._stopped = false;\n    // console.debug(`Starting ${this.constructor.name}`);\n    if (!this._animationFrameId) {\n      // Wait for start promise before rendering frame\n      this._startPromise = getPageLoadPromise()\n      .then(() => {\n        if (this._stopped) {\n          return null;\n        }\n\n        // Create the WebGL context\n        this._createWebGLContext(opts);\n\n        // Initialize the callback data\n        this._initializeCallbackData();\n        this._updateCallbackData();\n\n        // Default viewport setup, in case onInitialize wants to render\n        this._resizeCanvasDrawingBuffer();\n        this._resizeViewport();\n\n        // Note: onIntialize can return a promise (in case it needs to load resources)\n        return this._onInitialize(this._callbackData);\n      })\n      .then(appContext => {\n        if (!this._stopped) {\n          this._addCallbackData(appContext || {});\n          if (appContext !== false && !this._animationFrameId) {\n            this._animationFrameId = requestAnimationFrame(this._renderFrame);\n          }\n        }\n      });\n\n    }\n    return this;\n  }\n\n  // Stops a render loop if already running, finalizing\n  stop() {\n    // console.debug(`Stopping ${this.constructor.name}`);\n    if (this._animationFrameId) {\n      this._finalizeCallbackData();\n      cancelAnimationFrame(this._animationFrameId);\n      this._animationFrameId = null;\n      this._stopped = true;\n    }\n    return this;\n  }\n\n  // PRIVATE METHODS\n\n  _setupFrame() {\n    if (this._onSetupFrame) {\n      // call callback\n      this._onSetupFrame(this._callbackData);\n      // end callback\n    } else {\n      this._resizeCanvasDrawingBuffer();\n      this._resizeViewport();\n      this._resizeFramebuffer();\n    }\n  }\n\n  /**\n   * @private\n   * Handles a render loop frame- updates context and calls the application\n   * callback\n   */\n  _renderFrame() {\n    this._setupFrame();\n    this._updateCallbackData();\n\n    // call callback\n    this._onRender(this._callbackData);\n    // end callback\n\n    // Increment tick\n    this._callbackData.tick++;\n\n    if (!this._stopped) {\n      // Request another render frame (now )\n      this._animationFrameId = requestAnimationFrame(this._renderFrame);\n    }\n  }\n\n  // Initialize the  object that will be passed to app callbacks\n  _initializeCallbackData() {\n    this._callbackData = {\n      gl: this.gl,\n      canvas: this.gl.canvas,\n      framebuffer: this.framebuffer,\n      stop: this.stop,\n      // Initial values\n      tick: 0,\n      tock: 0,\n      useDevicePixels: this.useDevicePixels\n    };\n  }\n\n  // Update the context object that will be passed to app callbacks\n  _updateCallbackData() {\n    // CallbackData width and height represent drawing buffer width and height\n    const {canvas} = this.gl;\n    this._callbackData.width = canvas.width;\n    this._callbackData.height = canvas.height;\n    this._callbackData.aspect = canvas.width / canvas.height;\n  }\n\n  _finalizeCallbackData() {\n    // call callback\n    this._onFinalize(this._callbackData);\n    // end callback\n  }\n\n  // Add application's data to the app context object\n  _addCallbackData(appContext) {\n    if (typeof appContext === 'object' && appContext !== null) {\n      this._callbackData = Object.assign({}, this._callbackData, appContext);\n    }\n  }\n\n  // Either uses supplied or existing context, or calls provided callback to create one\n  _createWebGLContext(opts) {\n    // Create the WebGL context if necessary\n    opts = Object.assign({}, opts, this.glOptions);\n    if (opts.gl) {\n      this.gl = opts.gl;\n    } else {\n      this.gl = this._onCreateContext(opts);\n    }\n    if (!isWebGL(this.gl)) {\n      throw new Error('AnimationLoop.onCreateContext - illegal context returned');\n    }\n\n    // Setup default framebuffer\n    if (this._createFramebuffer) {\n      this.framebuffer = new Framebuffer(this.gl);\n    }\n    // Reset the WebGL context.\n    resetParameters(this.gl);\n  }\n\n  // Default viewport setup\n  _resizeViewport() {\n    if (this.autoResizeViewport) {\n      this.gl.viewport(0, 0, this.gl.canvas.width, this.gl.canvas.height);\n    }\n  }\n\n  _resizeFramebuffer() {\n    if (this.framebuffer) {\n      this.framebuffer.resize({width: this.gl.canvas.width, height: this.gl.canvas.height});\n    }\n  }\n\n  // Resize the render buffer of the canvas to match canvas client size\n  // Optionally multiplying with devicePixel ratio\n  _resizeCanvasDrawingBuffer() {\n    if (this.autoResizeDrawingBuffer) {\n      resizeDrawingBuffer(this.gl.canvas, {useDevicePixels: this.useDevicePixels});\n    }\n  }\n}\n"]}